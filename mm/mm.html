<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€ç¿»è¯‘ Â· 109ç§è¯­è¨€</title>
    <!-- æç®€é£æ ¼ï¼šæ— æ ·å¼ï¼Œåªä¿ç•™åŠŸèƒ½ -->
</head>
<body>
    <h2>ğŸŒ ç¿»è¯‘ (109ç§è¯­è¨€)</h2>
    
    <!-- æºè¯­è¨€ / ç›®æ ‡è¯­è¨€ -->
    <div style="margin-bottom: 8px;">
        <label>æºè¯­è¨€:
            <select id="fromLang" style="width: 140px;"></select>
        </label>
        <label style="margin-left: 10px;">ç›®æ ‡è¯­è¨€:
            <select id="toLang" style="width: 140px;"></select>
        </label>
    </div>

    <!-- è¾“å…¥æ–‡æœ¬æ¡† -->
    <div>
        <textarea id="sourceText" rows="4" cols="60" placeholder="è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬â€¦ ä¾‹å¦‚: Hello world">ã“ã‚“ã«ã¡ã¯</textarea>
    </div>

    <!-- ç¿»è¯‘æŒ‰é’® -->
    <div style="margin: 10px 0;">
        <button id="translateBtn">ç¿»è¯‘</button>
    </div>

    <!-- è¾“å‡ºè¯‘æ–‡ (åªè¯»æ–‡æœ¬æ¡†) -->
    <div>
        <textarea id="targetTextDisplay" rows="4" cols="60" readonly placeholder="è¯‘æ–‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ"></textarea>
    </div>

    <!-- é¢å¤–ä¿¡æ¯ (è¯­è¨€/å‘éŸ³) ä»¥æå°æ–‡å­—æ˜¾ç¤º -->
    <div style="font-size: 0.9em; color: #333; margin-top: 8px;">
        <span id="sourceMeta"></span> 
        <span id="targetMeta" style="margin-left: 20px;"></span>
    </div>

    <script>
        (function() {
            // API é…ç½®
            const API_BASE = 'https://60s.viki.moe';
            const TRANSLATE_PATH = '/v2/fanyi';
            const LANGS_PATH = '/fanyi/langs';

            // å¤‡é€‰è¯­è¨€ (å½“åŠ¨æ€åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨)
            const FALLBACK_LANGS = {
                'auto': 'ğŸŒ è‡ªåŠ¨æ£€æµ‹',
                'zh-CHS': 'ä¸­æ–‡(ç®€ä½“)',
                'en': 'è‹±æ–‡',
                'ja': 'æ—¥æ–‡',
                'ko': 'éŸ©æ–‡',
                'fr': 'æ³•æ–‡',
                'de': 'å¾·æ–‡',
                'ru': 'ä¿„æ–‡',
                'ar': 'é˜¿æ‹‰ä¼¯æ–‡',
                'pl': 'æ³¢å…°æ–‡',
                'la': 'æ‹‰ä¸æ–‡'
            };

            // DOM å…ƒç´ 
            const fromSelect = document.getElementById('fromLang');
            const toSelect = document.getElementById('toLang');
            const sourceTextArea = document.getElementById('sourceText');
            const translateBtn = document.getElementById('translateBtn');
            const targetTextDisplay = document.getElementById('targetTextDisplay');
            const sourceMetaSpan = document.getElementById('sourceMeta');
            const targetMetaSpan = document.getElementById('targetMeta');

            // åŠ è½½è¯­è¨€åˆ—è¡¨
            async function loadLanguages() {
                try {
                    const response = await fetch(`${API_BASE}${LANGS_PATH}`, {
                        method: 'GET',
                        mode: 'cors',
                        headers: { 'Accept': 'application/json' }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    
                    // è§£æè¯­è¨€æ˜ å°„
                    let langMap = new Map();
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            if (item.code && item.name) langMap.set(item.code, item.name);
                        });
                    } else if (data && typeof data === 'object') {
                        Object.entries(data).forEach(([code, name]) => {
                            if (typeof name === 'string') langMap.set(code, name);
                        });
                    }
                    
                    // ç¡®ä¿è‡³å°‘åŒ…å« auto
                    if (!langMap.has('auto')) langMap.set('auto', 'ğŸŒ è‡ªåŠ¨æ£€æµ‹');
                    if (langMap.size < 5) { // è§£æä¸å……åˆ†åˆ™åˆå¹¶ fallback
                        Object.entries(FALLBACK_LANGS).forEach(([code, name]) => {
                            if (!langMap.has(code)) langMap.set(code, name);
                        });
                    }
                    populateSelects(langMap);
                } catch (err) {
                    console.warn('è¯­è¨€åˆ—è¡¨åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨åˆ—è¡¨', err);
                    const fallbackMap = new Map(Object.entries(FALLBACK_LANGS));
                    populateSelects(fallbackMap);
                }
            }

            function populateSelects(langMap) {
                let optionsHtml = [];
                // auto ç½®é¡¶
                if (langMap.has('auto')) {
                    optionsHtml.push(`<option value="auto">${langMap.get('auto')}</option>`);
                    langMap.delete('auto');
                }
                // å…¶ä½™æ’åº
                const sorted = Array.from(langMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
                sorted.forEach(([code, name]) => {
                    optionsHtml.push(`<option value="${code}">${name}</option>`);
                });
                const optionsString = optionsHtml.join('');
                fromSelect.innerHTML = optionsString;
                toSelect.innerHTML = optionsString;
                fromSelect.value = 'auto';
                toSelect.value = 'auto';
            }

            // æ‰§è¡Œç¿»è¯‘
            async function performTranslation() {
                const text = sourceTextArea.value.trim();
                if (!text) {
                    alert('è¯·è¾“å…¥æ–‡æœ¬');
                    return;
                }

                const from = fromSelect.value;
                const to = toSelect.value;

                // ç¦ç”¨æŒ‰é’®ï¼Œé¿å…é‡å¤ç‚¹å‡»
                translateBtn.disabled = true;
                translateBtn.innerText = 'ç¿»è¯‘ä¸­...';

                try {
                    const params = new URLSearchParams({
                        text: text,
                        from: from,
                        to: to
                    });
                    const url = `${API_BASE}${TRANSLATE_PATH}?${params.toString()}`;

                    const response = await fetch(url, { mode: 'cors' });
                    if (!response.ok) throw new Error(`HTTPé”™è¯¯ ${response.status}`);
                    
                    const result = await response.json();
                    // æ ¹æ®è§„èŒƒåˆ¤æ–­æˆåŠŸ (code ä¸º 0 æˆ– 200 æˆ–å­˜åœ¨ data.source)
                    if (result.code === 0 || result.code === 200 || (result.data && result.data.target)) {
                        displayResult(result.data);
                    } else {
                        throw new Error(result.message || 'ç¿»è¯‘å¤±è´¥');
                    }
                } catch (error) {
                    targetTextDisplay.value = `é”™è¯¯: ${error.message}`;
                    sourceMetaSpan.innerText = '';
                    targetMetaSpan.innerText = '';
                } finally {
                    translateBtn.disabled = false;
                    translateBtn.innerText = 'ç¿»è¯‘';
                }
            }

            function displayResult(data) {
                if (!data || !data.target) {
                    targetTextDisplay.value = 'è¿”å›æ•°æ®å¼‚å¸¸';
                    return;
                }
                // è¯‘æ–‡æ˜¾ç¤ºåœ¨ä¸»æ–‡æœ¬æ¡†ä¸­
                targetTextDisplay.value = data.target.text || '';

                // å…ƒä¿¡æ¯æ˜¾ç¤º (æºè¯­è¨€ç±»å‹/å‘éŸ³, ç›®æ ‡è¯­è¨€ç±»å‹/å‘éŸ³)
                const src = data.source || {};
                const tgt = data.target || {};
                
                let srcInfo = [];
                if (src.type_desc) srcInfo.push(`åŸæ–‡: ${src.type_desc}`);
                if (src.pronounce) srcInfo.push(`å‘éŸ³: ${src.pronounce}`);
                sourceMetaSpan.innerText = srcInfo.join(' Â· ');

                let tgtInfo = [];
                if (tgt.type_desc) tgtInfo.push(`è¯‘æ–‡: ${tgt.type_desc}`);
                if (tgt.pronounce) tgtInfo.push(`å‘éŸ³: ${tgt.pronounce}`);
                targetMetaSpan.innerText = tgtInfo.join(' Â· ');
            }

            // åˆå§‹åŒ–
            loadLanguages();

            // ç»‘å®šäº‹ä»¶
            translateBtn.addEventListener('click', performTranslation);
            // Ctrl+Enter å¿«æ·ç¿»è¯‘
            sourceTextArea.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    performTranslation();
                }
            });

            // å¦‚æœé¢„å¡«äº†æ–‡æœ¬ï¼Œè‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ç¿»è¯‘
            if (sourceTextArea.value.trim() !== '') {
                setTimeout(performTranslation, 100);
            }
        })();
    </script>
</body>
</html>
